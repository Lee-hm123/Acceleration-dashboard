# STM32 F103C8T6+ MPU6050 实时加速度仪表盘系统（基于 PyQt5 + PyQtGraph）

该系统基于 STM32 F103C8T6微控制器与 MPU6050 加速度传感器，通过串口将加速度数据发送至电脑端，利用 Python 实现实时图形化显示。采用 PyQt5 构建交互界面，PyQtGraph 实现数据可视化，适用于传感器数据展示、嵌入式项目调试、动态运动监测等场景。

------

## 🧩 系统组成

- **STM32 F103C8T6+ MPU6050 硬件模块**：采集 X/Y/Z 三轴加速度值，并以 `[ACC] X=xxxmg Y=xxxmg Z=xxxmg` 格式通过串口定时接受数据。
- **仪表盘主程序（Python）**：解析串口数据并实时绘制加速度运动轨迹与四向 G 值。
- **PyQt5 图形界面**：展示中央小球运动、轨迹线、最大 G 值、水平仪指示线等动态组件。

------

## 🚀 核心功能

- **串口数据解析**
  - 通过 `COM4` 端口监听来自 STM32 的数据。
  - 使用正则表达式匹配标准格式 `[ACC] X=xxxmg Y=xxxmg Z=xxxmg`。
  - 自动将单位 mg 转换为 g（1g = 1000mg）。
- **实时图形仪表盘**
  - 中心圆盘显示当前加速度方向。
  - 橙色小球代表当前重力加速度中心。
  - 绘制历史轨迹线（白色半透明）。
  - 四个方向实时显示当前 G 值及历史最大值（Top/Bottom/Left/Right）。
  - 水平仪（绿色线条）指示当前设备倾斜方向，支持俯仰和横滚两种角度反馈。
- **动态计算与更新**
  - 每秒刷新位置、最大值、轨迹，延迟极低。
  - 使用时间窗口保留最近 2 秒内加速度历史值，动态计算最大值。
- **安全退出**
  - 关闭窗口时自动停止串口读取，避免资源未释放。

------

## 🔧 使用说明

1. 使用 STM32 F103C8T6开发板连接 MPU6050 传感器，并通过串口将数据发送至电脑（如 COM4）。

2. 打开文件夹`MPU6050`中的Keil项目编译下载到STM32F103C8T6。

3. 确保 Python 环境安装 PyQt5 与 pyqtgraph：

   ```bash
   pip install pyqt5 pyqtgraph numpy
   ```

4. 修改程序中的串口号 `PORT = xxx ` 为你的实际串口号，本项目默认波特率为115200。

5. 运行 Python 程序：

   ```bash
   python 加速度仪表盘.py
   ```

6. 启动后将自动显示仪表盘窗口并开始接收串口数据。

------

## ⚙️ 变量说明

### Python

| 名称 / 函数                 | 类型            | 功能说明                                                     |
| --------------------------- | --------------- | ------------------------------------------------------------ |
| `PORT`                      | 字符串          | 串口号，如 `'COM4'`，根据电脑实际配置修改。                  |
| `BAUD`                      | 整数            | 串口波特率，需与 STM32 端设置一致。                          |
| `SerialThread`              | QThread 类      | 负责后台读取串口数据，并通过信号 `new_data` 实时发送给主线程。 |
| `acc_pattern`               | 正则表达式      | 用于匹配格式 `[ACC] X=xxxmg Y=xxxmg Z=xxxmg`。               |
| `new_data.emit(ax, ay, az)` | 信号机制        | 将解析后的加速度值（单位 g）传递给主线程绘图函数。           |
| `GMeter`                    | 主窗口类        | 主图形界面类，负责绘制界面元素与更新图形。                   |
| `plot`                      | PyQtGraph 组件  | 用于绘图的核心区域。                                         |
| `dot`                       | ScatterPlotItem | 中心小球，实时反映加速度方向。                               |
| `trail`                     | PlotDataItem    | 轨迹线，用于记录小球运动历史。                               |
| `g_text_cur` / `g_text_max` | 字典            | 显示四个方向（上下左右）的当前值与最大值文本。               |
| `level_line`                | LineItem        | 绿色水平仪线条，模拟倾斜方向。                               |
| `g_history`                 | 列表缓存        | 保留历史加速度值用于最大值计算。                             |
| `max_window`                | 浮点数          | 最大值计算的时间窗口（单位：秒）。                           |
| `update_plot(ax, ay, az)`   | 方法            | 主绘图逻辑，包括小球更新、文本更新、轨迹维护、水平线旋转等。 |
| `closeEvent()`              | 方法            | 关闭窗口时停止串口线程、释放资源。                           |

------

### C语言（MPU6050)

##### 📁 文件目录结构说明（Keil工程）

```
📦 Project Root
├── user/
│   ├── main.c             // 主程序
├── Hardware/
│   ├── MPU6050.c / .h     // MPU6050 驱动与数据读取
│   ├── SI2C.c / .h        // 软件 I2C 实现（用于 MPU6050 通信）
│   ├── Key.c / .h         // 按键输入检测
│   ├── Led.c / .h         // LED 控制（红绿灯）
│   └── Serial.c / .h      // 串口通信、printf重定向
├── system/
│   └── Delay.c / .h       // 微秒/毫秒级延时函数
```
----

### 📡 Serial 串口通信模块

| 名称 / 函数                                    | 类型           | 功能说明                                                     |
| ---------------------------------------------- | -------------- | ------------------------------------------------------------ |
| `USART1`                                       | 外设指针宏     | 指向 `USART_TypeDef` 类型的宏，映射到 STM32 的 USART1 外设地址空间。 |
| `BAUD_RATE`                                    | 宏定义 / 变量  | 串口通信的波特率配置值，如 `115200`，需与上位机串口一致。    |
| `Serial_Init(void)`                            | 函数           | 初始化串口所需的 GPIO 引脚（如 TX、RX）与 USART 配置参数。   |
| `Serial_SendByte(uint8_t byte)`                | 函数           | 通过串口发送一个字节数据。                                   |
| `Serial_SendArray(uint8_t *buf, uint16_t len)` | 函数           | 通过串口连续发送指定长度的字节数组。                         |
| `Serial_SendString(char *str)`                 | 函数           | 通过串口发送以 `\0` 结尾的字符串。                           |
| `Serial_SendNumber(uint32_t num, uint8_t len)` | 函数           | 将整数转换为固定长度（不足补零）的数字字符串并通过串口发送。 |
| `Serial_Printf(const char *format, ...)`       | 函数           | 自封装的格式化输出函数，支持类似 `printf` 的格式字符串。     |
| `SendTripleChar(uint8_t ch)`                   | 函数           | 连续发送 3 次指定字符并在末尾添加一个空格（例如发送 `"--- "`）。 |
| `fputc(int ch, FILE *f)`                       | 函数（重定向） | 标准 C 库 `printf()` 的底层输出函数，重定向到串口实现调试输出。 |
| `Serial_ReceiveByte(void)`（可选）             | 函数           | 接收一个串口字节（若你实现了接收功能）。                     |
| `USART1_IRQHandler(void)`（可选）              | 中断函数       | 若开启串口中断接收，需编写的 USART1 中断服务函数。           |
| `Serial_SetCallback(void (*func)(uint8_t))`    | 函数           | 注册串口接收回调函数，用于中断接收模式下处理数据。           |

----

### 📦 MPU6050（传感器）

| 名称 / 函数          | 类型 | 功能说明                          |
| -------------------- | ---- | --------------------------------- |
| `MPU6050_Init()`     | 函数 | 初始化 MPU6050（通过软件 I2C）。  |
| `MPU6050_GetData()`  | 函数 | 读取 MPU6050 三轴加速度和角速度。 |
| `MPU6050_WriteReg()` | 函数 | 写入 MPU6050 寄存器               |
| ` MPU6050_ReadReg()` | 函数 | 读取 MPU6050 寄存器               |

---

### 🔌 软件 I2C 通信（SI2C）

| 名称 / 函数                   | 类型 | 功能说明                                        |
| ----------------------------- | ---- | ----------------------------------------------- |
| `SI2C_Init()`                 | 函数 | 初始化 I2C 引脚（PB6 SCL, PB7 SDA）为开漏输出。 |
| `I2C_Start()` / `I2C_Stop()`  | 函数 | 发送 I2C 起始 / 停止信号。                      |
| `I2C_SendByte(uint8_t)`       | 函数 | 向 I2C 总线发送一个字节。                       |
| `I2C_ReceiveByte()`           | 函数 | 从 I2C 总线读取一个字节。                       |
| `I2C_SendAck(uint8_t)`        | 函数 | 主设备发送 ACK 或 NACK。                        |
| `I2C_ReceiveAck()`            | 函数 | 主设备接收从设备返回的 ACK。                    |
| `I2C_W_SCL()` / `I2C_W_SDA()` | 函数 | 写 I2C 时钟 / 数据引脚电平。                    |
| `I2C_R_SDA()`                 | 函数 | 读取 SDA 引脚当前输入电平。                     |

---

### 🧲 LED 控制

| 名称 / 函数                   | 类型 | 功能说明                                              |
| ----------------------------- | ---- | ----------------------------------------------------- |
| `LED_Init()`                  | 函数 | 初始化红绿 LED 引脚为推挽输出（PB5 红灯，PB0 绿灯）。 |
| `RED_ON()` / `RED_OFF()`      | 函数 | 控制红灯亮灭。                                        |
| `GREEN_ON()` / `GREEN_OFF()`  | 函数 | 控制绿灯亮灭。                                        |
| `RED_Turn()` / `GREEN_Turn()` | 函数 | 红/绿灯状态翻转。                                     |

---

### 🔘 按键输入

| 名称 / 函数    | 类型 | 功能说明                                            |
| -------------- | ---- | --------------------------------------------------- |
| `Key_Init()`   | 函数 | 初始化按键引脚为上拉输入（PB1、PB11）。             |
| `Key_GetNum()` | 函数 | 阻塞式读取按键：返回 1 或 2，未按为 0，含消抖逻辑。 |

---

### ⏱ 延时控制

| 名称 / 函数          | 类型 | 功能说明                     |
| -------------------- | ---- | ---------------------------- |
| `Delay_us(uint32_t)` | 函数 | 微秒级延时函数。             |
| `Delay_ms(uint32_t)` | 函数 | 毫秒级延时函数（系统节拍）。 |

---

### 🧩 主程序逻辑（main.c）

| 名称 / 函数                        | 类型     | 功能说明                                                     |
| ---------------------------------- | -------- | ------------------------------------------------------------ |
| `main()`                           | 函数     | 程序入口。初始化所有模块，并在主循环中采集 MPU6050 数据并串口输出。 |
| `printf("AX=%d AY=%d AZ=%d", ...)` | 输出语句 | 输出格式化的加速度值，供上位机解析并绘图。                   |

---

## 📌 推荐输出格式（上位机配套）

在 `main.c` 中建议以如下格式输出加速度：

```c
printf("[ACC] X=%dmg Y=%dmg Z=%dmg\r\n", AX, AY, AZ);
printf("[GYRO] X=%ddps Y=%ddps Z=%ddps\r\n", GX, GY, GZ);
```

这样 Python 端的正则可以轻松匹配：

```python
r'\[ACC\]\s+X=(-?\d+)mg\s+Y=(-?\d+)mg\s+Z=(-?\d+)mg'
```

---

如需我为此项目写一份说明书模板（Word 或 Markdown），或帮你打包 `.hex` 上传程序结构，我也可以继续整理。是否需要？



## 📷 使用效果示意图



![屏幕截图 2025-05-29 233902](https://github.com/user-attachments/assets/34e0ae8f-6384-4366-92c7-ddf404fa38fc)


**视频**



https://github.com/user-attachments/assets/ba9d7dbc-f5bb-4d68-b4d8-a9a8a67dc2a4
